<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³ÛŒØ³ØªÙ… Ù‚ÛŒÙ…Øª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .stat-card.users { border-left-color: #667eea; }
        .stat-card.configs { border-left-color: #764ba2; }
        .stat-card.feedback { border-left-color: #f093fb; }
        .stat-card.logs { border-left-color: #4facfe; }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .stat-label {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .stat-subtitle {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.6em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .section-title i {
            color: #667eea;
        }

        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .price-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .price-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .price-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .price-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .price-change {
            font-size: 0.95em;
            padding: 8px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            display: inline-block;
        }

        .price-change.positive {
            background: rgba(76, 175, 80, 0.3);
        }

        .price-change.negative {
            background: rgba(244, 67, 54, 0.3);
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .user-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-icon {
            font-size: 2em;
        }

        .user-name {
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-id {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .feedback-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .feedback-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            background: #f0f0f0;
            transform: translateX(-5px);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feedback-user {
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .feedback-time {
            font-size: 0.85em;
            color: #999;
        }

        .feedback-text {
            color: #555;
            line-height: 1.6;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-right: 3px solid #667eea;
        }

        .logs-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-line {
            padding: 5px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-error {
            color: #ff6b6b;
        }

        .log-warning {
            color: #ffd93d;
        }

        .log-info {
            color: #00ff00;
        }

        .log-success {
            color: #6bcf7f;
        }

        .channel-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .channel-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .channel-stat:last-child {
            border-bottom: none;
        }

        .channel-stat-label {
            font-weight: 500;
        }

        .channel-stat-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .no-data i {
            font-size: 2.5em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .refresh-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-badge.online {
            background: #4caf50;
            color: white;
        }

        .status-badge.offline {
            background: #f44336;
            color: white;
        }

        .status-badge.warning {
            background: #ff9800;
            color: white;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .prices-grid {
                grid-template-columns: 1fr;
            }

            .users-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .refresh-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³ÛŒØ³ØªÙ… Ù‚ÛŒÙ…Øª</h1>
            <p>Ù†Ø¸Ø§Ø±Øª Ø¨Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±Ø¨Ø§Øª Ùˆ Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card users">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-label">Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-subtitle">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
            </div>

            <div class="stat-card configs">
                <div class="stat-icon">âš™ï¸</div>
                <div class="stat-label">Ú©Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</div>
                <div class="stat-value" id="totalConfigs">-</div>
                <div class="stat-subtitle">Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</div>
            </div>

            <div class="stat-card feedback">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-label">Ú©Ù„ ÙÛŒØ¯Ø¨Ú©â€ŒÙ‡Ø§</div>
                <div class="stat-value" id="totalFeedback">-</div>
                <div class="stat-subtitle">Ù†Ø¸Ø±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
            </div>

            <div class="stat-card logs">
                <div class="stat-icon">ğŸ•</div>
                <div class="stat-label">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</div>
                <div class="stat-value" id="lastUpdate">-</div>
                <div class="stat-subtitle" id="updateTime"></div>
            </div>
        </div>

        <!-- Prices Section -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                ğŸ’° Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
            </div>
            <div class="prices-grid" id="pricesContainer">
                <div class="no-data"><i class="fas fa-inbox"></i><p>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-users"></i>
                ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„
                <span class="status-badge online">ÙØ¹Ø§Ù„</span>
            </div>
            <div class="users-grid" id="usersContainer">
                <div class="no-data"><i class="fas fa-user-slash"></i><p>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>
            </div>
        </div>

        <!-- Feedback Section -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-comments"></i>
                ğŸ’¬ Ø¢Ø®Ø±ÛŒÙ† ÙÛŒØ¯Ø¨Ú©â€ŒÙ‡Ø§
                <span class="status-badge" id="feedbackBadge">Ø¬Ø¯ÛŒØ¯</span>
            </div>
            <div class="feedback-list" id="feedbackContainer">
                <div class="no-data"><i class="fas fa-inbox"></i><p>Ù‡Ù†ÙˆØ² ÙÛŒØ¯Ø¨Ú©ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡</p></div>
            </div>
        </div>

        <!-- Channel Stats Section -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-channel"></i>
                ğŸ“¢ Ø¢Ù…Ø§Ø± Ú©Ø§Ù†Ø§Ù„
            </div>
            <div id="channelStatsContainer">
                <div class="channel-section">
                    <div class="channel-stat">
                        <span class="channel-stat-label">Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„</span>
                        <span class="channel-stat-value" id="channelName">-</span>
                    </div>
                    <div class="channel-stat">
                        <span class="channel-stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§</span>
                        <span class="channel-stat-value" id="memberCount">-</span>
                    </div>
                    <div class="channel-stat">
                        <span class="channel-stat-label">Ø¹Ø¶ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</span>
                        <span class="channel-stat-value" id="recentJoins">-</span>
                    </div>
                    <div class="channel-stat">
                        <span class="channel-stat-label">ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª</span>
                        <span class="channel-stat-value" id="botStatus">âš ï¸ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-terminal"></i>
                ğŸ“‹ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
            </div>
            <div class="logs-container" id="logsContainer">
                <div class="log-line log-info">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§...</div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshAll()" title="Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª">
        <i class="fas fa-sync"></i>
    </button>

    <script>
        let autoRefreshInterval = null;

        async function loadDashboard() {
            try {
                const response = await fetch('/dashboard-data');
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data);

                if (!data || !data.stats) {
                    throw new Error('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ù…Ø§Ø±ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }

                // Update stats
                document.getElementById('totalUsers').textContent = data.stats.total_users || 0;
                document.getElementById('totalConfigs').textContent = data.stats.total_configs || 0;
                document.getElementById('totalFeedback').textContent = data.stats.total_feedback || 0;
                document.getElementById('lastUpdate').textContent = data.stats.last_update || '-';
                document.getElementById('updateTime').textContent = new Date().toLocaleString('fa-IR');

                // Update prices
                const pricesHtml = data.prices && data.prices.length > 0 
                    ? data.prices.map(p => `
                        <div class="price-item">
                            <div class="price-name">${p.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</div>
                            <div class="price-value">${p.price || '-'}</div>
                            <div class="price-change ${p.change_value >= 0 ? 'positive' : 'negative'}">
                                ${p.change_value >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${p.change_percent || 0}%
                            </div>
                        </div>
                    `).join('')
                    : '<div class="no-data"><i class="fas fa-inbox"></i><p>Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>';
                document.getElementById('pricesContainer').innerHTML = pricesHtml;

                // Update users
                const usersHtml = data.users && data.users.length > 0
                    ? data.users.map(u => `
                        <div class="user-item">
                            <div class="user-icon">ğŸ‘¤</div>
                            <div class="user-name">@${u.username || 'user'}</div>
                            <div class="user-id">ID: ${u.user_id}</div>
                        </div>
                    `).join('')
                    : '<div class="no-data"><i class="fas fa-user-slash"></i><p>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>';
                document.getElementById('usersContainer').innerHTML = usersHtml;

                // Update feedback
                const feedbackHtml = data.feedbacks && data.feedbacks.length > 0
                    ? data.feedbacks.map(f => `
                        <div class="feedback-item">
                            <div class="feedback-header">
                                <div class="feedback-user"><i class="fas fa-user-circle"></i> @${f.username || 'anonymous'}</div>
                                <div class="feedback-time">â° ${f.time || '-'}</div>
                            </div>
                            <div class="feedback-text">"${f.text || 'Ø¨Ø¯ÙˆÙ† Ù…ØªÙ†'}"</div>
                        </div>
                    `).join('')
                    : '<div class="no-data"><i class="fas fa-inbox"></i><p>Ù‡Ù†ÙˆØ² ÙÛŒØ¯Ø¨Ú©ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡</p></div>';
                document.getElementById('feedbackContainer').innerHTML = feedbackHtml;

                // Update channel stats
                try {
                    const channelResp = await fetch('/channel-stats');
                    const channelData = await channelResp.json();
                    
                    document.getElementById('channelName').textContent = channelData.channel_name || '-';
                    document.getElementById('memberCount').textContent = channelData.member_count || '0';
                    document.getElementById('recentJoins').textContent = channelData.recent_joins || '0';
                    
                    if (channelData.status === 'warning') {
                        document.getElementById('botStatus').textContent = 'âš ï¸ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ';
                    } else if (channelData.status === 'ok') {
                        document.getElementById('botStatus').textContent = 'âœ… ÙØ¹Ø§Ù„';
                    }
                } catch (e) {
                    console.warn('Channel stats error:', e);
                }

                // Update logs
                try {
                    const logsResp = await fetch('/logs?lines=50');
                    const logsData = await logsResp.json();
                    
                    let logsHtml = '';
                    if (logsData.logs && logsData.logs.trim()) {
                        logsData.logs.split('\n').forEach(line => {
                            if (line.trim()) {
                                let logClass = 'log-info';
                                if (line.includes('ERROR') || line.includes('âŒ')) logClass = 'log-error';
                                else if (line.includes('WARNING') || line.includes('âš ï¸')) logClass = 'log-warning';
                                else if (line.includes('âœ…') || line.includes('SUCCESS')) logClass = 'log-success';
                                logsHtml += `<div class="log-line ${logClass}">${escapeHtml(line)}</div>`;
                            }
                        });
                    } else {
                        logsHtml = '<div class="log-line log-info">ğŸ“ Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
                    }
                    document.getElementById('logsContainer').innerHTML = logsHtml;
                    // Scroll to bottom
                    document.getElementById('logsContainer').scrollTop = document.getElementById('logsContainer').scrollHeight;
                } catch (e) {
                    console.warn('Logs error:', e);
                }

            } catch (error) {
                console.error('Dashboard load error:', error);
                document.getElementById('pricesContainer').innerHTML = '<div class="no-data"><i class="fas fa-exclamation-circle"></i><p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ' + error.message + '</p></div>';
            }
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function refreshAll() {
            const btn = document.querySelector('.refresh-btn');
            btn.classList.add('loading');
            loadDashboard().finally(() => {
                btn.classList.remove('loading');
            });
        }

        // Load on page load
        loadDashboard();

        // Auto-refresh every 30 seconds
        autoRefreshInterval = setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
