<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø¨Ø§Øª Ù‚ÛŒÙ…Øª</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: slideDown 0.8s ease;
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 8px 20px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 300;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-15px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #888;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-number {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .card-header i {
            margin-left: 10px;
        }

        .toggle-switch {
            width: 60px;
            height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            right: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            right: 32px;
        }

        .card-body {
            padding: 30px;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .price-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 22px;
            border-radius: 15px;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
        }

        .price-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .price-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .price-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 12px 0;
        }

        .price-change {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .price-change.positive {
            color: var(--success);
        }

        .price-change.negative {
            color: var(--danger);
        }

        .users-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .user-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }

        .user-badge:hover {
            transform: scale(1.12);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.5);
        }

        .feedback-list {
            display: grid;
            gap: 15px;
        }

        .feedback-item {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            padding: 22px;
            border-radius: 15px;
            border-right: 5px solid var(--warning);
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            transform: translateX(-8px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
        }

        .feedback-user {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.05rem;
        }

        .feedback-text {
            color: #555;
            margin: 12px 0;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .feedback-time {
            font-size: 0.85rem;
            color: #999;
        }

        .logs-box {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 450px;
            overflow-y: auto;
            line-height: 1.8;
            border: 2px solid #333;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .log-line {
            padding: 3px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-info { color: #00ff00; }
        .log-warning { color: #ffaa00; }
        .log-error { color: #ff3333; }

        .no-data {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .no-data i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.5);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .price-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; gap: 15px; }
            .buttons-container { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }

        .loading-placeholder {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Ø±Ø¨Ø§Øª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</h1>
            <p>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ù†ØªØ±Ù„ Ùˆ Ù…Ø±Ø§Ù‚Ø¨Øª Ø³ÛŒØ³ØªÙ…</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-label">Ú©Ù„ Ø§Ø¹Ø¶Ø§</div>
                <div class="stat-number" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¦</div>
                <div class="stat-label">Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</div>
                <div class="stat-number" id="totalConfigs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-label">ÙÛŒØ¯Ø¨Ú©â€ŒÙ‡Ø§</div>
                <div class="stat-number" id="totalFeedback">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â°</div>
                <div class="stat-label">Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</div>
                <div class="stat-number" id="lastUpdate" style="font-size: 1.3rem;">-</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div><i class="fas fa-chart-line"></i> Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="card-body">
                <div class="price-grid" id="pricesContainer">
                    <div class="loading-placeholder"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div><i class="fas fa-users"></i> Ø§Ø¹Ø¶Ø§ÛŒ ÙØ¹Ø§Ù„</div>
            </div>
            <div class="card-body">
                <div class="users-grid" id="usersContainer">
                    <div class="loading-placeholder"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div><i class="fas fa-comments"></i> Ø¢Ø®Ø±ÛŒÙ† ÙÛŒØ¯Ø¨Ú©â€ŒÙ‡Ø§</div>
                <div class="toggle-switch active" id="feedbackToggle" onclick="toggleFeature('feedback_enabled', this)"></div>
            </div>
            <div class="card-body">
                <div class="feedback-list" id="feedbackContainer">
                    <div class="loading-placeholder"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div><i class="fas fa-users-alt"></i> Ø§Ø¹Ø¶Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„</div>
            </div>
            <div class="card-body">
                <div id="channelStatsContainer" style="text-align: center; padding: 30px;">
                    <p style="font-size: 1.1rem; color: #666;" id="channelStatsText">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    <div style="margin-top: 20px; color: #999; font-size: 0.95rem;" id="channelStatsDetail"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div><i class="fas fa-cog"></i> ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</div>
                <div class="toggle-switch active" id="configToggle" onclick="toggleFeature('config_enabled', this)"></div>
            </div>
            <div class="card-body" style="text-align: center; padding: 40px;">
                <p id="configStatus" style="font-size: 1.1rem; color: #666;">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                <div style="margin-top: 20px; color: #999; font-size: 0.95rem;">
                    ÙˆÛŒÚ˜Ú¯ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ <span id="configStatusBadge" style="font-weight: 700; color: var(--success);">ÙØ¹Ø§Ù„</span> Ø§Ø³Øª
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-terminal"></i> Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª
            </div>
            <div class="card-body">
                <div class="logs-box" id="logsContainer">
                    <div class="log-line">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
            </div>
        </div>

        <div class="buttons-container">
            <button class="btn" onclick="loadDashboard()">
                <i class="fas fa-sync-alt"></i> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </button>
            <button class="btn" onclick="saveSettings()">
                <i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
            </button>
        </div>
    </div>

    <script>
        let settings = {};

        async function loadDashboard() {
            try {
                const response = await fetch('/dashboard-data');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Full data received:', data);

                // Ø¨Ø±Ø±Ø³ÛŒ ØµØ­ÛŒØ­ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                if (!data) {
                    console.error('Data is null or undefined');
                    throw new Error('Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
                
                if (!data.stats) {
                    console.error('Stats object missing:', data);
                    throw new Error('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ù…Ø§Ø±ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }

                document.getElementById('totalUsers').textContent = data.stats.total_users || 0;
                document.getElementById('totalConfigs').textContent = data.stats.total_configs || 0;
                document.getElementById('totalFeedback').textContent = data.stats.total_feedback || 0;
                document.getElementById('lastUpdate').textContent = data.stats.last_update || '-';

                const pricesHtml = data.prices && data.prices.length > 0 
                    ? data.prices.map(p => `
                        <div class="price-item">
                            <div class="price-name">${p.name}</div>
                            <div class="price-value">${p.price}</div>
                            <div class="price-change ${p.change_value >= 0 ? 'positive' : 'negative'}">
                                ${p.change_value >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${p.change_percent}%
                            </div>
                        </div>
                    `).join('')
                    : '<div class="no-data"><i class="fas fa-inbox"></i><p>Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>';
                document.getElementById('pricesContainer').innerHTML = pricesHtml;

                const usersHtml = data.users && data.users.length > 0
                    ? data.users.map(u => `<div class="user-badge">ğŸ‘¤ ${u.username}</div>`).join('')
                    : '<div class="no-data"><i class="fas fa-user-slash"></i><p>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>';
                document.getElementById('usersContainer').innerHTML = usersHtml;

                const feedbackHtml = data.feedbacks && data.feedbacks.length > 0
                    ? data.feedbacks.map(f => `
                        <div class="feedback-item">
                            <div class="feedback-user"><i class="fas fa-user-circle"></i> ${f.username}</div>
                            <div class="feedback-text">"${f.text}"</div>
                            <div class="feedback-time">â° ${f.time}</div>
                        </div>
                    `).join('')
                    : '<div class="no-data"><i class="fas fa-inbox"></i><p>Ù‡Ù†ÙˆØ² ÙÛŒØ¯Ø¨Ú©ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡</p></div>';
                document.getElementById('feedbackContainer').innerHTML = feedbackHtml;

                // Load channel stats
                const channelResp = await fetch('/channel-stats');
                const channelData = await channelResp.json();
                
                if (channelData.status === 'warning') {
                    document.getElementById('channelStatsText').textContent = 'âš ï¸ ' + channelData.message;
                    document.getElementById('channelStatsDetail').innerHTML = `
                        <p>Ú©Ø§Ù†Ø§Ù„: <strong>${channelData.channel_name}</strong></p>
                        <p style="margin-top: 15px; color: #666;">Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ:</p>
                        <ol style="text-align: right; color: #666;">
                            <li>Ø±Ø¨Ø§Øª Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</li>
                            <li>Ø±Ø¨Ø§Øª Ø±Ø§ admin Ú©Ù†ÛŒØ¯</li>
                            <li>ØµÙØ­Ù‡ Ø±Ø§ ØªØ§Ø²Ù‡ Ú©Ù†ÛŒØ¯</li>
                        </ol>
                    `;
                }

                const logsResp = await fetch('/logs?lines=50');
                const logsData = await logsResp.json();
                
                let logsHtml = '';
                if (logsData.logs && logsData.logs.trim()) {
                    logsData.logs.split('\n').forEach(line => {
                        if (line.trim()) {
                            let logClass = 'log-info';
                            if (line.includes('ERROR') || line.includes('âŒ')) logClass = 'log-error';
                            else if (line.includes('WARNING') || line.includes('âš ï¸')) logClass = 'log-warning';
                            logsHtml += `<div class="log-line ${logClass}">${escapeHtml(line)}</div>`;
                        }
                    });
                } else {
                    logsHtml = '<div class="log-line">Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
                }
                document.getElementById('logsContainer').innerHTML = logsHtml;

                const settingsResp = await fetch('/settings');
                settings = await settingsResp.json();
                updateToggles();
                updateConfigStatus();

            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                document.getElementById('pricesContainer').innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p></div>';
            }
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function updateToggles() {
            if (settings.features) {
                ['feedback_enabled', 'config_enabled'].forEach(key => {
                    const toggle = document.getElementById(key.replace('_enabled', '') + 'Toggle');
                    if (toggle && settings.features[key] !== undefined) {
                        toggle.classList.toggle('active', settings.features[key]);
                    }
                });
            }
        }

        function updateConfigStatus() {
            const enabled = !settings.features || settings.features.config_enabled !== false;
            document.getElementById('configStatusBadge').textContent = enabled ? 'âœ… ÙØ¹Ø§Ù„' : 'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„';
            document.getElementById('configStatusBadge').style.color = enabled ? 'var(--success)' : 'var(--danger)';
            document.getElementById('configStatus').textContent = enabled 
                ? 'âœ… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ú¯ÛŒØ±Ù†Ø¯' 
                : 'âŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ú¯ÛŒØ±Ù†Ø¯';
        }

        async function toggleFeature(feature, element) {
            if (!settings.features) settings.features = {};
            settings.features[feature] = !settings.features[feature];
            element.classList.toggle('active');
            if (feature === 'config_enabled') updateConfigStatus();
        }

        async function saveSettings() {
            try {
                await fetch('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            } catch (error) {
                alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª');
            }
        }

        loadDashboard();
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
