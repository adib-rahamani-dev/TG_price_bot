<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ØµÙØ­Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ ÙˆÛŒâ€ŒØªÙˆâ€ŒØ±ÛŒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background:#f7f9fc; }
      .card { margin-top:30px }
      textarea { font-family: monospace; height: 220px }
      .cfg-item { white-space: pre-wrap; font-family: monospace; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="card-title">Ø«Ø¨Øª Ú©Ø§Ù†ÙÛŒÚ¯ ÙˆÛŒâ€ŒØªÙˆâ€ŒØ±ÛŒ</h4>
          <p class="text-muted">Ú©Ø§Ù†ÙÛŒÚ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± textarea Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯. Ø³Ù¾Ø³ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.</p>

          <div class="mb-3">
            <label class="form-label">Ù†Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <input id="name" class="form-control" placeholder="ÛŒÚ© Ø§Ø³Ù… Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ù†ÙÛŒÚ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
          </div>

          <div class="mb-3">
            <label class="form-label">Ú©Ø§Ù†ÙÛŒÚ¯</label>
            <textarea id="config" class="form-control" placeholder="Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯"></textarea>
          </div>

          <div class="d-flex gap-2">
            <button id="saveBtn" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
            <button id="clearBtn" class="btn btn-outline-secondary">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            <button id="getConfigsBtn" class="btn btn-success">ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</button>
            <a class="btn btn-info" href="/random?n=10" target="_blank">ğŸ² Ù†Ù…Ø§ÛŒØ´ 10 Ø±Ù†Ø¯ÙˆÙ…</a>
          </div>

          <div id="msg" class="mt-3"></div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h5>Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</h5>
          <div id="list" class="mt-2"></div>
        </div>
      </div>

      <!-- Modal Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ -->
      <div class="modal fade" id="configsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="configsList"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center text-muted mt-4">Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ±: <code>http://YOUR_SERVER_IP:8080/</code></footer>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      async function loadList(){
        try{
          const res = await fetch('/list');
          const arr = await res.json();
          const list = document.getElementById('list');
          if(!arr || !arr.length){ list.innerHTML = '<div class="text-muted">Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'; return }
          list.innerHTML = '';
          arr.slice(-20).reverse().forEach((it, i)=>{
            const el = document.createElement('div'); el.className='mb-2';
            el.innerHTML = `<div class=\"card p-2\"><div class=\"d-flex justify-content-between\"><strong>${it.name||'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'}</strong><small class=\"text-muted\">${it.time}</small></div><pre class=\"cfg-item mt-2\">${escapeHtml(it.config)}</pre></div>`
            list.appendChild(el);
          })
        }catch(e){ console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª:', e) }
      }
      function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

      document.getElementById('saveBtn').addEventListener('click', async ()=>{
        const config = document.getElementById('config').value.trim();
        const name = document.getElementById('name').value.trim();
        const msg = document.getElementById('msg');
        if(!config){ msg.innerHTML='<div class="text-danger">Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>'; return }
        msg.innerHTML = '<div class="text-muted">Ø¯Ø±Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...</div>';
        const form = new FormData();
        form.append('config', config);
        form.append('name', name);
        try{
          console.log('Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ù‡ /save...');
          const res = await fetch('/save', { method:'POST', body: form });
          console.log('ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø®:', res.status);
          const j = await res.json();
          console.log('Ù¾Ø§Ø³Ø® Ø¬ÛŒØ³ÙˆÙ†:', j);
          if(j.ok){ msg.innerHTML = '<div class="text-success">âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.</div>'; document.getElementById('config').value=''; document.getElementById('name').value=''; loadList() }
          else msg.innerHTML = '<div class="text-danger">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + (j.error||'Ù†Ø§Ù…Ø´Ø®Øµ') + '</div>';
        }catch(e){ 
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:', e);
          msg.innerHTML = '<div class="text-danger">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ' + e.message + '</div>' 
        }
      })
      document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('config').value=''; document.getElementById('name').value=''; })
      
      // Ø¯Ú©Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
      document.getElementById('getConfigsBtn').addEventListener('click', async ()=>{
        try{
          const res = await fetch('/list');
          const cfgs = await res.json();
          if(!cfgs || !cfgs.length){ alert('Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); return }
          
          let html = '';
          cfgs.slice(-50).reverse().forEach((cfg, i)=>{
            html += `<div class="card mb-2 p-3">
              <div class="d-flex justify-content-between mb-2">
                <strong>${cfg.name||'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'}</strong>
                <small class="text-muted">${cfg.time}</small>
              </div>
              <pre style="background:#f5f5f5;padding:10px;border-radius:5px;overflow-x:auto">${escapeHtml(cfg.config)}</pre>
              <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard(this)">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            </div>`;
          });
          
          document.getElementById('configsList').innerHTML = html;
          new bootstrap.Modal(document.getElementById('configsModal')).show();
        }catch(e){
          console.error('Ø®Ø·Ø§:', e);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§: ' + e.message);
        }
      })
      
      function copyToClipboard(btn){
        const pre = btn.previousElementSibling;
        const text = pre.textContent;
        navigator.clipboard.writeText(text).then(()=>{
          btn.textContent = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯';
          setTimeout(()=>{ btn.textContent = 'ğŸ“‹ Ú©Ù¾ÛŒ' }, 2000);
        }).catch(e=>alert('Ø®Ø·Ø§: ' + e));
      }
      
      loadList();
    </script>
  </body>
</html>
